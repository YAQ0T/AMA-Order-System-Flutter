<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safari iOS Diagnostic</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 20px;
            background: #0f172a;
            color: white;
        }

        .test {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }

        .pass {
            border-left: 4px solid #22c55e;
        }

        .fail {
            border-left: 4px solid #ef4444;
        }

        button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            margin: 5px;
            font-size: 16px;
        }

        #log {
            background: #000;
            padding: 10px;
            margin-top: 20px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <h1>Safari iOS Diagnostic</h1>
    <p>Device: <span id="device"></span></p>
    <p>User Agent: <span id="ua"></span></p>

    <div id="tests"></div>

    <h2>Actions</h2>
    <button onclick="testLocalStorage()">Test LocalStorage</button>
    <button onclick="testFetch()">Test Fetch API</button>
    <button onclick="testServiceWorker()">Test Service Worker</button>
    <button onclick="clearStorage()">Clear Storage</button>

    <h2>Console Log</h2>
    <div id="log"></div>

    <script>
        const logDiv = document.getElementById('log');
        const testsDiv = document.getElementById('tests');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ef4444' : type === 'success' ? '#22c55e' : '#94a3b8';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function addTest(name, passed, details = '') {
            const div = document.createElement('div');
            div.className = `test ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `
                <strong>${name}</strong>: ${passed ? '✓ PASS' : '✗ FAIL'}
                ${details ? `<br><small>${details}</small>` : ''}
            `;
            testsDiv.appendChild(div);
        }

        // Device info
        document.getElementById('device').textContent = navigator.platform;
        document.getElementById('ua').textContent = navigator.userAgent;

        // Run tests
        log('Starting diagnostic tests...');

        // Test 1: Basic JavaScript
        try {
            const test = [1, 2, 3].map(x => x * 2);
            addTest('JavaScript ES6', true, 'Arrow functions and array methods work');
            log('✓ JavaScript ES6 features working', 'success');
        } catch (e) {
            addTest('JavaScript ES6', false, e.message);
            log('✗ JavaScript ES6 error: ' + e.message, 'error');
        }

        // Test 2: LocalStorage
        try {
            localStorage.setItem('test', 'value');
            const val = localStorage.getItem('test');
            addTest('LocalStorage', val === 'value', `Stored and retrieved: ${val}`);
            log('✓ LocalStorage working', 'success');
        } catch (e) {
            addTest('LocalStorage', false, e.message);
            log('✗ LocalStorage error: ' + e.message, 'error');
        }

        // Test 3: Fetch API
        function testFetch() {
            log('Testing Fetch API to backend...');
            const apiUrl = 'https://10.10.10.56:6001/api/auth/login';
            fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: 'test', password: 'test' })
            })
                .then(response => {
                    log(`✓ Fetch response: ${response.status}`, 'success');
                    return response.json();
                })
                .then(data => {
                    log(`Response data: ${JSON.stringify(data)}`, 'success');
                })
                .catch(error => {
                    log(`✗ Fetch error: ${error.message}`, 'error');
                });
        }

        // Test 4: Service Worker
        function testServiceWorker() {
            if ('serviceWorker' in navigator) {
                log('Service Worker API available', 'success');
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => {
                        log('✓ Service Worker registered: ' + reg.scope, 'success');
                    })
                    .catch(err => {
                        log('✗ Service Worker registration failed: ' + err.message, 'error');
                    });
            } else {
                log('✗ Service Worker not supported', 'error');
            }
        }

        // Test 5: Module support
        addTest('ES Modules', typeof import.meta !== 'undefined', 'import.meta available: ' + (typeof import.meta !== 'undefined'));

        // Test 6: Check for stored auth
        const storedToken = localStorage.getItem('token');
        const storedUser = localStorage.getItem('user');
        addTest('Stored Auth', storedToken !== null, `Token: ${storedToken ? 'exists' : 'none'}, User: ${storedUser ? 'exists' : 'none'}`);

        if (storedToken) {
            log(`Found stored token: ${storedToken.substring(0, 20)}...`);
        }
        if (storedUser) {
            log(`Found stored user: ${storedUser}`);
        }

        function testLocalStorage() {
            log('Testing LocalStorage...');
            try {
                const testData = { test: 'data', timestamp: Date.now() };
                localStorage.setItem('diagnostic', JSON.stringify(testData));
                const retrieved = JSON.parse(localStorage.getItem('diagnostic'));
                log('✓ LocalStorage read/write successful: ' + JSON.stringify(retrieved), 'success');
            } catch (e) {
                log('✗ LocalStorage error: ' + e.message, 'error');
            }
        }

        function clearStorage() {
            if (confirm('Clear all localStorage data?')) {
                localStorage.clear();
                log('✓ LocalStorage cleared', 'success');
                location.reload();
            }
        }

        // Global error handler
        window.addEventListener('error', (e) => {
            log('✗ Global error: ' + e.message, 'error');
        });

        window.addEventListener('unhandledrejection', (e) => {
            log('✗ Unhandled promise rejection: ' + e.reason, 'error');
        });

        log('Diagnostic page loaded successfully', 'success');
    </script>
</body>

</html>
